<!DOCTYPE html>
<html>
<head>
    <title>Simple Prompt</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
        }

        textarea {
            width: 100%;
            overflow-y: scroll;
            scroll-behavior: smooth;
            resize: vertical;
        }

        #textarea {
            height: 50vh;
        }

        .fullWidthButton {
            width: 100%;
        }

        .container {
            width: 99vw;
        }

        .containerText {
            float: top;
        }

        .containerOptions {
            float: bottom;
        }
    </style>
</head>
<body onkeydown="onKeyPress(event)">

<div class="container">
    <div class="containerText">
        <textarea id="textarea"
                  placeholder="Type your text directly here then press ctrl+enter or click the Continue button"></textarea>
    </div>
    <div class="containerOptions">
        <textarea rows="1" id="textareaTokens" disabled>Tokens: 0/2048</textarea>
        <textarea rows="4" id="textareaAnswer"
                  placeholder="Generated text will appear here. You can press ctrl+enter again to retry, or ctrl+right shift to paste output onto the main text"></textarea>
        <textarea rows="1" id="textareaTokensAnswer" disabled>Tokens: 0</textarea>
        <textarea rows="4" id="textareaAnswerTokens"
                  placeholder="Here will be displayed the tokens of the output area, you can use it to experiment with tokens!"
                  disabled></textarea>
        <button class="fullWidthButton" id="sendButton">Continue (ctrl + enter)</button>
        <button class="fullWidthButton" id="pasteInPromptButton">Paste result to prompt (ctrl + right shift)</button>
        <span>Tokens to generate <input id="nbTokenToGenerate" max="100" type="number" value="10"></span>
        <span>Temperature <input id="temperature" type="number" value="0.9"></span>
        <span>Top K <input id="top_k" type="number" value="90"></span>
        <span>Top P <input id="top_p" type="number" value="0.6"></span>
        <span>Repetition Penalty <input id="repetition_penalty" type="number" value="2.5"></span>
        <span>Repetition Penalty Range <input id="repetition_penalty_range" type="number" value="512"></span>
        <span>Repetition Penalty Slope <input id="repetition_penalty_slope" type="number" value="3.33"></span>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

    const socket = io()

    const textarea = document.getElementById("textarea")
    const textareaTokens = document.getElementById("textareaTokens")
    const textareaAnswer = document.getElementById("textareaAnswer")
    const textareaTokensAnswer = document.getElementById("textareaTokensAnswer")
    const textareaAnswerTokens = document.getElementById("textareaAnswerTokens")
    const inputNbToken = document.getElementById("nbTokenToGenerate")
    const inputTemperature = document.getElementById("temperature")
    const inputTopK = document.getElementById("top_k")
    const inputTopP = document.getElementById("top_p")
    const inputRepetitionPenalty = document.getElementById("repetition_penalty")
    const inputRepetitionPenaltyRange = document.getElementById("repetition_penalty_range")
    const inputRepetitionPenaltySlope = document.getElementById("repetition_penalty_slope")
    const sendButton = document.getElementById("sendButton")
    const pasteInPromptButton = document.getElementById("pasteInPromptButton")

    function sendPrompt() {
        if (textarea.value) {
            socket.emit(
                "prompt",
                textarea.value,
                parseInt(inputNbToken.value),
                parseFloat(inputTemperature.value),
                parseInt(inputTopK.value),
                parseFloat(inputTopP.value),
                parseFloat(inputRepetitionPenalty.value),
                parseInt(inputRepetitionPenaltyRange.value),
                parseFloat(inputRepetitionPenaltySlope.value),
            )
        }
    }

    textarea.onkeyup = async () => {
        socket.emit("tokens", textarea.value, "tokensPrompt")
    }

    textareaAnswer.onkeyup = async () => {
        socket.emit("tokens", textareaAnswer.value, "tokensAnswer")
    }

    function onKeyPress(e) {
        if (e.keyCode === 13 && e.ctrlKey) {
            sendPrompt()
        } else if (e.code === "ShiftRight" && e.ctrlKey) {
            appendAnswerToTextArea()
        }
    }

    socket.on("tokens", (answer, id) => {
        if (id === "tokensPrompt") {
            textareaTokens.value = "Tokens: " + answer.length + "/2048"
        } else if (id === "tokensAnswer") {
            textareaTokensAnswer.value = "Tokens: " + answer.length
            textareaAnswerTokens.value = answer.map(s => s).join(' | ')
        }
    })

    sendButton.onclick = sendPrompt

    function appendAnswerToTextArea(answer = textareaAnswer.value) {
        textarea.value += " " + answer
        textarea.value = textarea.value
            .replace(/  +/g, " ")
            .replace(/\n /g, "\n")
            .replace(/ \./g, ".")
            .replace(/ ,/g, ",")
            .replace(/' /g, "'")
        textareaAnswer.value = ""
        textareaTokensAnswer.value = "Tokens: 0"
        socket.emit("tokens", textarea.value, "tokensPrompt")
        sendPrompt()
    }

    pasteInPromptButton.onclick = () => {
        appendAnswerToTextArea()
    }

    socket.on("prompt", (prompt, answer, tokensPrompt, tokensAnswer) => {
        textareaAnswer.value = answer
        socket.emit("tokens", textarea.value, "tokensPrompt")
        socket.emit("tokens", textareaAnswer.value, "tokensAnswer")
    })
</script>
</body>
</html>